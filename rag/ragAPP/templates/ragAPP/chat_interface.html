{% extends 'ragAPP/base.html' %}

{% block title %}Chat Interface{% endblock %}

{% block extra_css %}
<style>
  .chat-container {
    height: 600px;
    border: 1px solid #dee2e6;
    border-radius: 12px;
    background: white;
  }
  
  .chat-messages {
    height: 480px;
    overflow-y: auto;
    padding: 20px;
    background: #f8f9fa;
  }
  
  .message {
    margin-bottom: 20px;
    animation: fadeIn 0.3s ease-in;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  .message-user {
    text-align: right;
  }
  
  .message-bot {
    text-align: left;
  }
  
  .message-bubble {
    display: inline-block;
    max-width: 70%;
    padding: 12px 16px;
    border-radius: 18px;
    word-wrap: break-word;
  }
  
  .message-user .message-bubble {
    background: var(--color-dark);
    color: white;
  }
  
  .message-bot .message-bubble {
    background: white;
    color: var(--color-darkest);
    border: 1px solid #dee2e6;
  }
  
  .message-time {
    font-size: 0.75rem;
    color: #6c757d;
    margin-top: 5px;
  }
  
  .chat-input-area {
    padding: 20px;
    border-top: 1px solid #dee2e6;
    background: white;
    border-radius: 0 0 12px 12px;
  }
  
  .typing-indicator {
    display: none;
    padding: 10px 16px;
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 18px;
    margin-bottom: 10px;
  }
  
  .typing-dots {
    display: inline-block;
  }
  
  .typing-dots span {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    background: #6c757d;
    margin: 0 2px;
    animation: typing 1.4s infinite ease-in-out;
  }
  
  .typing-dots span:nth-child(1) { animation-delay: -0.32s; }
  .typing-dots span:nth-child(2) { animation-delay: -0.16s; }
  
  @keyframes typing {
    0%, 80%, 100% { transform: scale(0.8); opacity: 0.5; }
    40% { transform: scale(1); opacity: 1; }
  }
  
  .retrieved-chunks {
    margin-top: 10px;
    padding: 10px;
    background: rgba(0, 123, 255, 0.1);
    border-radius: 8px;
    font-size: 0.85rem;
  }
  
  .chunk-item {
    background: white;
    border: 1px solid #dee2e6;
    border-radius: 6px;
    padding: 8px;
    margin: 5px 0;
  }
  
  .chunk-similarity {
    color: #28a745;
    font-weight: 600;
  }
</style>
{% endblock %}

{% block content %}
<!-- Header -->
<div class="row mb-4">
  <div class="col-12">
    <div class="d-flex justify-content-between align-items-center">
      <div>
        <h1 class="display-6 step-title mb-2">Chat Interface</h1>
        <p class="text-muted">Ask questions about your uploaded documents</p>
      </div>
      <a href="{% url 'document_text_interface' %}" class="btn btn-outline-primary">
        <i class="bi bi-arrow-left me-2"></i>Back to Interface
      </a>
    </div>
  </div>
</div>

<!-- Knowledge Base Status -->
<div class="row mb-4">
  <div class="col-12">
    <div class="alert alert-info d-flex align-items-center">
      <i class="bi bi-info-circle me-3"></i>
      <div>
        <strong>Knowledge Base Status:</strong>
        {{ documents.count }} document{{ documents.count|pluralize }} uploaded, 
        {{ total_chunks }} text chunk{{ total_chunks|pluralize }} processed
        {% if not documents %}
          <br><small>Upload documents in the <a href="{% url 'knowledge_base' %}">Knowledge Base</a> to start chatting.</small>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- Chat Container -->
<div class="row">
  <div class="col-12">
    <div class="chat-container">
      <!-- Chat Messages -->
      <div class="chat-messages" id="chatMessages">
        {% if messages %}
          {% for message in messages %}
          <div class="message message-user">
            <div class="message-bubble">
              {{ message.message }}
            </div>
            <div class="message-time">{{ message.timestamp|date:"H:i" }}</div>
          </div>
          <div class="message message-bot">
            <div class="message-bubble">
              {{ message.response|linebreaks }}
              {% if message.retrieved_chunks %}
              <div class="retrieved-chunks">
                <small><strong>ðŸ“š Sources:</strong></small>
                {% for chunk_id in message.retrieved_chunks %}
                <div class="chunk-item">
                  <small>Chunk ID: {{ chunk_id }}</small>
                </div>
                {% endfor %}
              </div>
              {% endif %}
            </div>
            <div class="message-time">{{ message.timestamp|date:"H:i" }}</div>
          </div>
          {% endfor %}
        {% else %}
          <div class="text-center py-5">
            <i class="bi bi-chat-dots" style="font-size: 3rem; color: var(--color-light);"></i>
            <h5 class="mt-3 text-muted">Start a conversation</h5>
            <p class="text-muted">Ask me anything about your uploaded documents!</p>
          </div>
        {% endif %}
        
        <!-- Typing Indicator -->
        <div class="message message-bot">
          <div class="typing-indicator" id="typingIndicator">
            <div class="typing-dots">
              <span></span>
              <span></span>
              <span></span>
            </div>
            <span class="ms-2">AI is thinking...</span>
          </div>
        </div>
      </div>
      
      <!-- Chat Input -->
      <div class="chat-input-area">
        <form id="chatForm">
          <div class="input-group">
            <input type="text" class="form-control" id="messageInput" 
                   placeholder="Ask a question about your documents..." 
                   {% if not documents %}disabled{% endif %}>
            <button type="submit" class="btn btn-primary" id="sendButton" 
                    {% if not documents %}disabled{% endif %}>
              <i class="bi bi-send"></i>
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- Quick Questions -->
{% if documents %}
<div class="row mt-4">
  <div class="col-12">
    <div class="card step-card">
      <div class="card-body">
        <h6 class="card-title">ðŸ’¡ Try asking:</h6>
        <div class="d-flex flex-wrap gap-2">
          <button class="btn btn-sm btn-outline-secondary quick-question" data-question="What is this document about?">
            What is this document about?
          </button>
          <button class="btn btn-sm btn-outline-secondary quick-question" data-question="Summarize the main points">
            Summarize the main points
          </button>
          <button class="btn btn-sm btn-outline-secondary quick-question" data-question="What are the key findings?">
            What are the key findings?
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const chatForm = document.getElementById('chatForm');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const chatMessages = document.getElementById('chatMessages');
    const typingIndicator = document.getElementById('typingIndicator');
    const quickQuestions = document.querySelectorAll('.quick-question');
    
    const sessionId = '{{ session_id }}';
    
    // Auto-scroll to bottom
    function scrollToBottom() {
        chatMessages.scrollTop = chatMessages.scrollHeight;
    }
    
    // Add message to chat
    function addMessage(message, isUser = true, response = null, chunks = null) {
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${isUser ? 'message-user' : 'message-bot'}`;
        
        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { 
            hour12: false, 
            hour: '2-digit', 
            minute: '2-digit' 
        });
        
        let chunksHtml = '';
        if (chunks && chunks.length > 0) {
            chunksHtml = '<div class="retrieved-chunks"><small><strong>ðŸ“š Sources:</strong></small>';
            chunks.forEach(chunk => {
                chunksHtml += `
                    <div class="chunk-item">
                        <small><strong>${chunk.document_title}</strong> (Similarity: <span class="chunk-similarity">${(chunk.similarity * 100).toFixed(1)}%</span>)</small>
                        <div style="font-size: 0.8rem; color: #6c757d; margin-top: 3px;">
                            ${chunk.text.substring(0, 100)}${chunk.text.length > 100 ? '...' : ''}
                        </div>
                    </div>
                `;
            });
            chunksHtml += '</div>';
        }
        
        messageDiv.innerHTML = `
            <div class="message-bubble">
                ${isUser ? message : (response || message).replace(/\n/g, '<br>')}
                ${chunksHtml}
            </div>
            <div class="message-time">${timeString}</div>
        `;
        
        // Insert before typing indicator
        chatMessages.insertBefore(messageDiv, typingIndicator.parentElement);
        scrollToBottom();
    }
    
    // Show/hide typing indicator
    function showTyping(show = true) {
        typingIndicator.style.display = show ? 'block' : 'none';
        if (show) scrollToBottom();
    }
    
    // Send message
    async function sendMessage(message) {
        if (!message.trim()) return;
        
        // Add user message
        addMessage(message, true);
        
        // Show typing indicator
        showTyping(true);
        
        // Disable input
        messageInput.disabled = true;
        sendButton.disabled = true;
        
        try {
            const response = await fetch('{% url "chat_query" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    query: message,
                    session_id: sessionId
                })
            });
            
            const data = await response.json();
            
            if (response.ok) {
                // Add bot response
                addMessage(data.response, false, data.response, data.retrieved_chunks);
            } else {
                addMessage(`Error: ${data.error}`, false);
            }
        } catch (error) {
            addMessage(`Error: ${error.message}`, false);
        } finally {
            // Hide typing indicator
            showTyping(false);
            
            // Re-enable input
            messageInput.disabled = false;
            sendButton.disabled = false;
            messageInput.focus();
        }
    }
    
    // Form submission
    chatForm.addEventListener('submit', function(e) {
        e.preventDefault();
        const message = messageInput.value.trim();
        if (message) {
            sendMessage(message);
            messageInput.value = '';
        }
    });
    
    // Quick questions
    quickQuestions.forEach(button => {
        button.addEventListener('click', function() {
            const question = this.dataset.question;
            messageInput.value = question;
            sendMessage(question);
            messageInput.value = '';
        });
    });
    
    // Auto-focus input
    messageInput.focus();
    
    // Initial scroll to bottom
    scrollToBottom();
});
</script>
{% endblock %}
